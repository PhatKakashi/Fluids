<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Body Fluids Processing — Practice Game</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#0f172a">
<style>
  :root{--bg:#0f172a;--card:#0b1222;--muted:#94a3b8;--text:#e5e7eb;--line:#223046;--ok:#22c55e;--warn:#f59e0b;--bad:#ef4444}
  *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  html,body{margin:0;background:linear-gradient(180deg,#0a0f21,#0f172a);color:var(--text);font:16px/1.45 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif}
  header{position:sticky;top:0;z-index:5;padding:12px 14px;background:rgba(10,15,33,.88);backdrop-filter:saturate(1.2) blur(8px);border-bottom:1px solid var(--line)}
  h1{margin:0 0 2px;font-size:18px}
  .subtitle{color:var(--muted);font-size:12px}
  main{padding:14px;max-width:980px;margin:0 auto}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  select,button,input[type="number"],input[type="text"],textarea{background:#111a2b;border:1px solid var(--line);color:var(--text);border-radius:12px;padding:12px 14px;font-size:16px}
  button{cursor:pointer}
  button.primary{background:linear-gradient(180deg,#22c55e,#16a34a);border:none;color:#fff;font-weight:700}
  button.ghost{background:#111a2b}
  .wrap{display:grid;gap:14px}
  .card{background:rgba(11,18,34,.9);border:1px solid var(--line);border-radius:14px;padding:14px}
  .score{display:flex;gap:8px;flex-wrap:wrap}
  .badge{font-size:12px;color:var(--muted);border:1px solid var(--line);padding:6px 8px;border-radius:999px}
  .question{font-size:18px;margin:8px 0 10px}
  .answers{display:grid;gap:8px}
  .answers button{justify-content:flex-start;text-align:left;border-radius:12px;padding:14px}
  .result{display:none;margin-top:10px;padding:12px;border-radius:12px;font-size:15px}
  .result.good{display:block;background:rgba(34,197,94,.12);border:1px solid rgba(34,197,94,.5)}
  .result.bad{display:block;background:rgba(239,68,68,.12);border:1px solid rgba(239,68,68,.5)}
  .tiny{font-size:12px;color:var(--muted)}
  .pill{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:4px 8px;font-size:12px;color:var(--muted)}
  .slots{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
  .slot{flex:1 1 120px;min-width:120px;background:#0b1428;border:1px dashed var(--line);padding:10px;border-radius:10px;text-align:center}
  .chips{display:flex;gap:8px;flex-wrap:wrap}
  .chip{background:#16213a;border:1px solid var(--line);padding:10px 12px;border-radius:10px}
  details{background:#0b1428;border:1px solid var(--line);border-radius:10px;padding:8px 10px}
  summary{cursor:pointer}
  .danger{color:#ffb4b4}
  .footer{padding-bottom:28px}
</style>
</head>
<body>
<header>
  <h1>Body Fluids Processing — Practice</h1>
  <div class="subtitle">Tap to answer. Built for iPhone (no drag).</div>
  <div class="row" style="margin-top:8px">
    <select id="mode">
      <option value="mixed">Mode: Mixed</option>
      <option value="triage">Mode: Low‑Volume Triage</option>
      <option value="ordering">Mode: Tube Order & Priorities</option>
      <option value="rules">Mode: Rules / MCQ</option>
      <option value="calc">Mode: Exudate vs Transudate</option>
    </select>
    <button id="start" class="primary">Start / Next</button>
    <button id="reveal" class="ghost">Reveal</button>
  </div>
</header>

<main class="wrap">
  <section class="card">
    <div class="score">
      <span class="badge">Q: <b id="qnum">0</b></span>
      <span class="badge">Correct: <b id="correct">0</b></span>
      <span class="badge">Streak: <b id="streak">0</b></span>
      <span class="badge">Mode: <b id="label-mode">Mixed</b></span>
      <span class="badge">Strict <input id="strict" type="checkbox" style="vertical-align:middle;margin-left:6px"></span>
      <span class="badge">#Qs <input id="nq" type="number" min="1" max="200" value="20" style="width:72px;margin-left:6px"></span>
    </div>
    <div id="qwrap">
      <p class="question">Tap <b>Start</b> to begin.</p>
    </div>
    <div id="feedback" class="result"></div>
  </section>

  <section class="card">
    <p class="tiny"><b>Reference Hints</b></p>
    <ul class="tiny" style="margin-top:6px">
      <li>Low volume + infection suspected: <b>culture & cell count first</b>; chemistry if leftover.</li>
      <li>Typical CSF 4‑tube convention: <b>Chem/Serology → Microbiology → Cell count → Reserve</b> (follow local policy).</li>
      <li>Pleural exudate: <b>Light’s criteria</b> (PF/S protein &gt;0.5, PF/S LDH &gt;0.6, PF LDH &gt; 2/3 ULN).</li>
      <li>Synovial: normal ↑ viscosity; inflammation ↓ viscosity; crystals if indicated.</li>
      <li>Use a BSC for aerosol risk (e.g., TB r/o).</li>
    </ul>
    <details style="margin-top:8px">
      <summary>Quick Light’s Criteria Calculator</summary>
      <div class="row" style="margin-top:6px">
        <input id="pprot" type="number" step="0.1" placeholder="Pleural Protein (g/dL)">
        <input id="sprot" type="number" step="0.1" placeholder="Serum Protein (g/dL)">
      </div>
      <div class="row" style="margin-top:6px">
        <input id="pldh" type="number" step="1" placeholder="Pleural LDH (U/L)">
        <input id="sldh" type="number" step="1" placeholder="Serum LDH (U/L)">
        <input id="uln"  type="number" step="1" placeholder="Serum LDH ULN (U/L)">
      </div>
      <div class="row" style="margin-top:8px"><button class="ghost" onclick="calcLight()">Evaluate</button></div>
      <div id="lightOut" class="tiny" style="margin-top:6px"></div>
    </details>
    <details style="margin-top:8px">
      <summary>Add Your Own Question (optional)</summary>
      <p class="tiny">Paste one JSON object and tap <b>Add</b>. Types: <code>mcq</code>, <code>triage</code>, <code>ordering</code>, <code>calc</code>.</p>
      <textarea id="customJSON" rows="5" style="width:100%"></textarea>
      <div class="row" style="margin-top:6px"><button class="ghost" onclick="addCustom()">Add</button></div>
      <p class="tiny danger">Note: This only adds to the current session (no saving between reloads).</p>
    </details>
  </section>

  <div class="footer tiny" style="text-align:center;color:#8ea2c8">
    Tip: After Pages is enabled, open the green link it shows. On iPhone you can Share → <b>Add to Home Screen</b>.
  </div>
</main>

<script>
/* ---------- Question Bank ---------- */
const bank = {
  mcq: [
    {
      q: "CSF just arrived: 0.8 mL across 2 tubes. Orders: protein, glucose; note says 'r/o meningitis'. What’s the priority?",
      choices: [
        "Chemistry first due to MD request",
        "Split evenly between chemistry and cell count",
        "Microbiology & cell count first; chemistry if leftover",
        "Freeze and do everything tomorrow"
      ],
      answer: 2,
      why: "Low volume + suspected infection → culture/Gram & cell count first. CSF cells lyse quickly; culture yield falls with delays."
    },
    {
      q: "Best additive tube for cell count/differential on serous fluids?",
      choices: ["Plain (no additive)","Heparin (green)","EDTA (lavender)","Citrate (blue)"],
      answer: 2,
      why: "EDTA prevents clotting and preserves cellular morphology."
    },
    {
      q: "Milky pleural fluid. Which test best supports chylous effusion?",
      choices: ["Triglycerides","Amylase","pH","Uric acid"],
      answer: 0,
      why: "Triglycerides >110 mg/dL suggests chylous effusion; chylomicrons confirm."
    },
    {
      q: "TB suspected in pleural fluid. Key safety measure while making smears?",
      choices: ["Open bench + mask","Class II BSC + appropriate PPE","Warm specimen to 37°C","Skip smear; culture only"],
      answer: 1,
      why: "Use a biosafety cabinet for aerosol‑generating work."
    },
    {
      q: "Synovial fluid is thin and watery. Most suggestive of:",
      choices: ["Normal (HA intact)","Inflammation with ↓ viscosity","Anticoagulant contamination","Chylous effusion"],
      answer: 1,
      why: "Inflammation degrades hyaluronic acid → decreased viscosity."
    },
    {
      q: "Common 4‑tube CSF convention: which tube for cell counts?",
      choices: ["Tube 1","Tube 2","Tube 3","Tube 4"],
      answer: 2,
      why: "Typical convention: 1 Chem/Serology, 2 Micro, 3 Hematology (cell count), 4 Reserve (follow local policy)."
    },
    {
      q: "Pleural fluid: protein 4.2; serum protein 6.8; PF LDH 310; serum LDH 420 (ULN 200). Classify.",
      choices: ["Transudate","Exudate","Indeterminate","Need glucose to decide"],
      answer: 1,
      why: "PF/S protein 0.62 (>0.5) and PF LDH > 2/3 ULN (310 > 133) → exudate."
    },
    {
      q: "Best rapid, sensitive test for cryptococcal meningitis on CSF:",
      choices: ["India ink","Cryptococcal antigen (CrAg)","Gram stain","AFB smear"],
      answer: 1,
      why: "CSF CrAg has superior sensitivity vs India ink; culture recommended."
    }
  ],
  triage: [
    {
      scenario: "Peritoneal fluid 1.2 mL, 'r/o SBP'; orders: culture, cell count, protein, albumin.",
      options: ["Culture & cell count first; protein/albumin if leftover","Protein & albumin first","Room temp hold; batch later","Spin all → chemistry only"],
      answer: 0,
      why: "Low volume + infection → culture + PMN count (≥250/µL suggests SBP)."
    },
    {
      scenario: "CSF 0.5 mL, fever/HA; orders include culture, glucose, protein, LDH.",
      options: ["Glucose & protein first","Culture + cytospin/Gram first; chemistry if any left","LDH only; most stable","Reject for volume"],
      answer: 1,
      why: "Prioritize microbiology and cell count in suspected meningitis."
    },
    {
      scenario: "Pleural fluid 5 mL, 'r/o malignancy vs pneumonia'; orders: cytology, culture, pH, LDH, protein.",
      options: ["All to cytology","Culture & pH promptly; then LDH/protein; cytology if possible","Only chemistry now","Freeze entire sample"],
      answer: 1,
      why: "pH & cultures are time‑sensitive; then chem; cytology ideally needs larger volume."
    }
  ],
  ordering: [
    {
      q: "Tap to set the usual 4‑tube CSF order (1 → 4).",
      items: ["Chem/Serology","Microbiology","Cell count","Reserve"],
      answer: ["Chem/Serology","Microbiology","Cell count","Reserve"],
      why: "Common convention; follow your lab’s policy if different."
    },
    {
      q: "Prioritize sequence for fragile, low‑volume CSF ('r/o meningitis'):",
      items: ["Culture/Gram","Cell count/cytospin","Chemistry (protein/glucose)"],
      answer: ["Culture/Gram","Cell count/cytospin","Chemistry (protein/glucose)"],
      why: "Culture & cells first; chemistry last if volume limits."
    }
  ],
  calc: [
    {
      q: "Apply Light’s Criteria. Enter values and classify.",
      fields: ["Pleural Protein","Serum Protein","Pleural LDH","Serum LDH","Serum LDH ULN"],
      sample: [3.8,7.0,280,380,200],
      why: "Exudate if any: PF/S protein >0.5, PF/S LDH >0.6, PF LDH > 2/3 ULN."
    }
  ]
};

/* ---------- State & Helpers ---------- */
let state = { qnum:0, correct:0, streak:0, remaining:20, mode:'mixed', current:null, strict:false };

const el = id => document.getElementById(id);
const shuffle = a => a.map(x=>[Math.random(),x]).sort((p,q)=>p[0]-q[0]).map(x=>x[1]);

function setMode(){ const m = el('mode').value; state.mode = m; el('label-mode').textContent = el('mode').selectedOptions[0].text.replace('Mode: ','') || m; }
el('mode').addEventListener('change', setMode);

function startSession(){
  state.qnum=0; state.correct=0; state.streak=0;
  state.remaining=parseInt(el('nq').value||'20',10);
  state.strict=el('strict').checked;
  nextQuestion();
}

function pickQuestion(){
  let m = state.mode;
  if (m==='mixed'){ const modes=['mcq','triage','ordering','calc']; m = modes[Math.floor(Math.random()*modes.length)]; }
  let q;
  if (m==='mcq') q = {...rand(bank.mcq), type:'mcq'};
  if (m==='triage') q = {...rand(bank.triage), type:'triage'};
  if (m==='ordering') q = {...rand(bank.ordering), type:'ordering'};
  if (m==='calc') q = {...rand(bank.calc), type:'calc'};
  return q;
}
const rand = arr => arr[Math.floor(Math.random()*arr.length)];

function nextQuestion(){
  const fb = el('feedback'); fb.className='result'; fb.textContent='';
  if (state.remaining<=0){
    el('qwrap').innerHTML = `
      <p class="question">Session complete! 🎉</p>
      <p class="tiny">Score: <b>${state.correct}</b> correct out of <b>${el('nq').value}</b>.</p>
      <button class="primary" onclick="startSession()">Restart</button>`;
    return;
  }
  state.qnum += 1;
  const q = pickQuestion(); state.current = q;
  if (q.type==='mcq') renderMCQ(q);
  if (q.type==='triage') renderTriage(q);
  if (q.type==='ordering') renderOrdering(q);
  if (q.type==='calc') renderCalc(q);
  updateScore();
}

function updateScore(){ el('qnum').textContent=state.qnum; el('correct').textContent=state.correct; el('streak').textContent=state.streak; }

function grade(ok, why){
  if (ok){ state.correct+=1; state.streak+=1; showFeedback(true,"Correct ✅",why); }
  else { state.streak=0; showFeedback(false,"Not quite ❌",why); if (state.strict) return; }
  state.remaining -= 1; updateScore();
}

function showFeedback(ok,title,why){
  const fb = el('feedback'); fb.className='result '+(ok?'good':'bad');
  fb.innerHTML = `<b>${title}</b><div class="tiny" style="margin-top:6px">${why||''}</div>`;
}

function reveal(){
  const q = state.current; if(!q) return;
  let text='';
  if (q.type==='mcq') text = `Answer: <b>${q.choices[q.answer]}</b><br>${q.why}`;
  if (q.type==='triage') text = `Answer: <b>${q.options[q.answer]}</b><br>${q.why}`;
  if (q.type==='ordering') text = `Order: <b>${q.answer.join(' → ')}</b><br>${q.why}`;
  if (q.type==='calc') text = q.why;
  showFeedback(true,"Reveal",text);
}

/* ---------- Renderers ---------- */
function renderMCQ(q){
  el('qwrap').innerHTML = `
    <div class="pill">Question ${state.qnum}</div>
    <p class="question">${q.q}</p>
    <div class="answers" id="answers"></div>`;
  const a = el('answers');
  const idxs = q.choices.map((_,i)=>i); const shuffled = shuffle(idxs);
  shuffled.forEach(i=>{
    const b = document.createElement('button');
    b.textContent = q.choices[i];
    b.onclick = ()=> grade(i===q.answer, q.why);
    a.appendChild(b);
  });
}

function renderTriage(q){
  el('qwrap').innerHTML = `
    <div class="pill">Low‑Volume Triage</div>
    <p class="question">${q.scenario}</p>
    <div class="answers" id="answers"></div>`;
  const a = el('answers');
  q.options.forEach((opt,i)=>{
    const b=document.createElement('button'); b.textContent=opt; b.onclick=()=>grade(i===q.answer,q.why); a.appendChild(b);
  });
}

function renderOrdering(q){
  // Tap to build order into slots; tap chips to fill, tap slots to clear
  const items = shuffle(q.items.slice());
  const slots = q.answer.length;
  el('qwrap').innerHTML = `
    <div class="pill">Ordering / Priority</div>
    <p class="question">${q.q}</p>
    <div class="chips" id="chips"></div>
    <div class="slots" id="slots"></div>
    <div class="row" style="margin-top:8px"><button id="submitOrder" class="ghost">Submit</button></div>`;
  const chips = el('chips'); const s = el('slots');
  items.forEach(text=>{
    const c=document.createElement('button'); c.className='chip'; c.textContent=text; c.onclick=()=>addToSlot(c); chips.appendChild(c);
  });
  for (let i=0;i<slots;i++){
    const slot=document.createElement('div'); slot.className='slot'; slot.dataset.index=i; slot.textContent='Tap chip to fill';
    slot.onclick=()=>{ if (slot.dataset.value){ // clear
        const txt = slot.dataset.value; slot.dataset.value=''; slot.textContent='Tap chip to fill';
        // restore chip
        const c=document.createElement('button'); c.className='chip'; c.textContent=txt; c.onclick=()=>addToSlot(c); chips.appendChild(c);
      }};
    s.appendChild(slot);
  }
  el('submitOrder').onclick=()=>{
    const order=[...s.children].map(x=>x.dataset.value||'');
    if (order.some(x=>!x)){ showFeedback(false,"Not quite ❌","Fill all positions first."); return; }
    const ok = JSON.stringify(order)===JSON.stringify(q.answer);
    grade(ok, q.why);
  };

  function addToSlot(chipEl){
    // place into first empty slot
    const empty = [...s.children].find(x=>!x.dataset.value);
    if (!empty) return;
    empty.dataset.value = chipEl.textContent;
    empty.textContent = chipEl.textContent;
    chipEl.remove();
  }
}

function renderCalc(q){
  el('qwrap').innerHTML = `
    <div class="pill">Calculator</div>
    <p class="question">${q.q}</p>
    <div class="row tiny">
      <input id="c_pprot" type="number" step="0.1" value="${q.sample?.[0]??''}" placeholder="Pleural Protein (g/dL)">
      <input id="c_sprot" type="number" step="0.1" value="${q.sample?.[1]??''}" placeholder="Serum Protein (g/dL)">
    </div>
    <div class="row tiny" style="margin-top:6px">
      <input id="c_pldh" type="number" step="1" value="${q.sample?.[2]??''}" placeholder="Pleural LDH (U/L)">
      <input id="c_sldh" type="number" step="1" value="${q.sample?.[3]??''}" placeholder="Serum LDH (U/L)">
      <input id="c_uln"  type="number" step="1" value="${q.sample?.[4]??''}" placeholder="Serum LDH ULN (U/L)">
    </div>
    <div class="row" style="margin-top:8px"><button id="eval" class="ghost">Classify</button></div>`;
  el('eval').onclick=()=>{
    const pprot=parseFloat(el('c_pprot').value), sprot=parseFloat(el('c_sprot').value),
          pldh=parseFloat(el('c_pldh').value), sldh=parseFloat(el('c_sldh').value),
          uln=parseFloat(el('c_uln').value);
    const res=classifyLight(pprot,sprot,pldh,sldh,uln);
    grade(true, `Per Light’s criteria → <b>${res.classification}</b>.<br>${res.explain}`);
  };
}

/* ---------- Utilities ---------- */
function calcLight(){
  const pprot=parseFloat(el('pprot').value), sprot=parseFloat(el('sprot').value),
        pldh=parseFloat(el('pldh').value), sldh=parseFloat(el('sldh').value),
        uln=parseFloat(el('uln').value);
  const res=classifyLight(pprot,sprot,pldh,sldh,uln);
  el('lightOut').innerHTML = `<b>${res.classification}</b> — ${res.explain}`;
}

function classifyLight(pprot,sprot,pldh,sldh,uln){
  if ([pprot,sprot,pldh,sldh,uln].some(x=>isNaN(x))) return {classification:"Need values", explain:"Enter all five values to evaluate."};
  const r1=pprot/sprot, r2=pldh/sldh, r3 = pldh>(2/3)*uln;
  const ex = (r1>0.5)||(r2>0.6)||r3;
  const explain = `PF/S protein = ${r1.toFixed(2)}; PF/S LDH = ${r2.toFixed(2)}; PF LDH ${r3?'>' : '≤'} 2/3 ULN.`;
  return {classification: ex?'Exudate':'Transudate', explain};
}

function addCustom(){
  const txt = el('customJSON').value.trim(); if(!txt) return alert('Paste a JSON object.');
  try{
    const obj = JSON.parse(txt); if (!obj.type) throw new Error('Missing "type".');
    if (!bank[obj.type]) bank[obj.type]=[];
    bank[obj.type].push(obj); el('customJSON').value=''; alert('Added. It will appear this session.');
  }catch(e){ alert('Invalid JSON: '+e.message); }
}

/* ---------- Wire Up ---------- */
el('start').addEventListener('click', startSession);
el('reveal').addEventListener('click', reveal);
setMode();
</script>
</body>
</html>
